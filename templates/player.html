<!DOCTYPE html>
<html>
<head>
    <title>DHL Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif; text-align: center; padding: 10px; color: #333;
            background-color: #f4f4f4;
            background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
        }
        .box {
            background: white; padding: 20px; border-radius: 8px; margin-top: 10px;
            border-bottom: 5px solid #D40511; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: box-shadow 0.5s ease;
        }
        .player-badge {
            font-size: 24px; font-weight: 900; text-transform: uppercase;
            background: #FFCC00; color: #D40511; padding: 10px 25px;
            border-radius: 30px; display: inline-block; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        input[type=text] { padding: 12px; font-size: 16px; width: 80%; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 4px; }
        button { background: #D40511; color: white; border: none; padding: 15px; font-size: 18px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: background 0.3s;}
        button:disabled { background: #999; cursor: not-allowed; }
        .hidden { display: none !important; }
        input[type=range] {
            width: 100%; height: 40px; -webkit-appearance: none; appearance: none;
            background: #ccc; border-radius: 20px; outline: none; margin: 25px 0; cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 40px; height: 40px;
            background: white; border: 4px solid #555; border-radius: 50%; cursor: pointer;
        }
        .slider-blue { background: #007bff !important; }
        .labels { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; text-transform: uppercase; }
        .lbl-left { color: #007bff; text-align: left; }
        .lbl-right { color: #007bff; text-align: right; }
        #timer_bar { height: 10px; background: #FFCC00; width: 100%; border-radius: 5px; transition: width 1s linear; }
        .status-header { font-size: 30px; font-weight: 900; text-transform: uppercase; margin-bottom: 5px;}
        .msg-text { font-size: 20px; font-weight: bold; margin-bottom: 15px; line-height: 1.3; }
        .pts-large { font-size: 50px; font-weight: 900; margin: 10px 0; }
        .ans-box { background: #eee; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .bonus-tag {
            background: #FFCC00; color: #D40511; padding: 8px 20px; border-radius: 20px;
            font-weight: bold; display: block; margin: 10px auto;
            text-align: center; width: fit-content; text-transform: uppercase;
        }
        .lb-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.98); z-index:9999; padding-top: 20px; overflow-y: auto;}
        table { width: 90%; margin: 0 auto; border-collapse: collapse; }
        th { background: #FFCC00; color: #D40511; padding: 10px; }
        td { border-bottom: 1px solid #ddd; padding: 10px; font-size: 16px; }
        .winner-txt { font-size: 30px; color: #D40511; font-weight: bold; margin: 20px 0; }
    </style>
</head>
<body>
    <div id="player_display" class="player-badge hidden"></div>

    <div id="login_screen" class="box">
        <h3>Join Game</h3>
        <input type="text" id="username" placeholder="Enter Name">
        <button onclick="joinGame()">Join</button>
    </div>

    <div id="wait_screen" class="hidden box">
        <h3 id="wait_msg">Waiting for Host...</h3>
    </div>

    <div id="game_screen" class="hidden box">
        <div style="background:#ddd; height:10px; border-radius:5px; margin-bottom:15px;"><div id="timer_bar"></div></div>
        <h3 id="q_text" style="min-height: 50px;">Loading...</h3>
        <div class="labels">
            <div class="lbl-left">IDEAL</div>
            <div class="lbl-right">CHALLENGING</div>
        </div>
        <input type="range" id="slider" min="0" max="100" step="50" value="50">
        <p id="slider_val" style="font-weight:bold; color:#555;">Slide Left or Right</p>
        <button id="submit_btn" onclick="submitAnswer()">SUBMIT ANSWER</button>
    </div>

    <div id="feedback_screen" class="hidden box">
        <div id="fb_status" class="status-header"></div>
        <div id="fb_msg" class="msg-text"></div>
        <div id="fb_pts" class="pts-large"></div>
        <div class="ans-box">
            <span style="font-size:12px; color:#555;">Correct Answer:</span><br>
            <span id="fb_ans" style="font-weight:bold; font-size:18px;"></span>
        </div>
        <div id="fb_bonuses"></div>
        <img id="rr_gif" src="https://media.giphy.com/media/2dbnhlCH2JhwdI2gHp/giphy.gif" class="hidden" style="width:150px; margin: 10px auto; border-radius:10px;">
        <p id="fb_exp" style="color:#666; font-style:italic; margin-top:15px; border-top:1px solid #eee; padding-top:10px;"></p>
        <p style="font-size:12px; margin-top:20px;">Waiting for next...</p>
    </div>

    <div id="lb_overlay" class="lb-overlay hidden">
        <div id="winner_section" class="hidden">
            <h1>WINNER</h1>
            <div id="winner_name" class="winner-txt"></div>
        </div>
        <h2>LEADERBOARD</h2>
        <table id="lb_table"></table>
        <p style="margin-top:20px; color:#666;">Waiting for Host to continue...</p>
    </div>

    <script>
        var socket = io();
        var currentTimer;
        var slider = document.getElementById('slider');
        var sliderTxt = document.getElementById('slider_val');

        // Persistent identity token (prevents name collisions and enables robust reconnect)
        function getToken() {
            var t = localStorage.getItem("dhl_game_token");
            if (!t) {
                // simple UUID-like token
                t = "t_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
                localStorage.setItem("dhl_game_token", t);
            }
            return t;
        }

        var myName = localStorage.getItem("dhl_game_name") || "";

        function sendJoin() {
            if (!myName) return;
            socket.emit('join_game', { token: getToken(), name: myName });
        }

        slider.oninput = function() {
            slider.classList.remove('slider-blue');
            if (this.value == "0") {
                slider.classList.add('slider-blue');
                sliderTxt.innerHTML = "Selection: IDEAL";
                sliderTxt.style.color = "#007bff";
            } else if (this.value == "100") {
                slider.classList.add('slider-blue');
                sliderTxt.innerHTML = "Selection: CHALLENGING";
                sliderTxt.style.color = "#007bff";
            } else {
                sliderTxt.innerHTML = "Slide Left or Right";
                sliderTxt.style.color = "#555";
            }
        };

        function joinGame() {
            var name = document.getElementById('username').value;
            if(!name) return alert("Enter Name");
            myName = name;
            localStorage.setItem("dhl_game_name", myName);

            document.getElementById('player_display').innerHTML = name.toUpperCase();
            document.getElementById('player_display').classList.remove('hidden');

            sendJoin();

            document.getElementById('login_screen').classList.add('hidden');
            document.getElementById('wait_screen').classList.remove('hidden');
        }

        // Auto-rejoin on reconnect
        socket.on('connect', function() {
            if (myName) {
                // restore badge
                document.getElementById('player_display').innerHTML = myName.toUpperCase();
                document.getElementById('player_display').classList.remove('hidden');
                sendJoin();
            }
        });

        // If name exists from previous session, show wait screen immediately
        window.addEventListener("load", function() {
            if (myName) {
                document.getElementById('login_screen').classList.add('hidden');
                document.getElementById('wait_screen').classList.remove('hidden');
                document.getElementById('player_display').innerHTML = myName.toUpperCase();
                document.getElementById('player_display').classList.remove('hidden');
            }
        });

        socket.on('force_reload', function() { window.location.reload(); });

        socket.on('wait_screen', function(data) {
            document.getElementById('wait_msg').innerHTML = data.msg;
            showScreen('wait_screen');
        });

        socket.on('new_question', function(data) {
            document.getElementById('lb_overlay').classList.add('hidden');
            var gameBox = document.getElementById('game_screen');
            gameBox.classList.remove('hidden');
            gameBox.style.boxShadow = "0 4px 15px rgba(0,0,0,0.1)";

            document.getElementById('login_screen').classList.add('hidden');
            document.getElementById('wait_screen').classList.add('hidden');
            document.getElementById('feedback_screen').classList.add('hidden');
            document.getElementById('rr_gif').classList.add('hidden');

            document.getElementById('q_text').innerHTML = "Q" + data.q_id + ": " + data.text;

            slider.value = 50;
            slider.classList.remove('slider-blue');
            sliderTxt.innerHTML = "Slide Left or Right";
            sliderTxt.style.color = "#555";

            var btn = document.getElementById('submit_btn');
            btn.disabled = false;
            btn.innerHTML = "SUBMIT ANSWER";
            btn.style.background = "#D40511";

            var timeLeft = data.duration;
            var totalTime = data.duration;
            var bar = document.getElementById('timer_bar');
            bar.style.width = "100%";

            if(currentTimer) clearInterval(currentTimer);
            currentTimer = setInterval(function() {
                timeLeft--;

                // clamp to 0..100 to avoid negative widths
                var pct = Math.max(0, Math.min(100, (timeLeft / totalTime) * 100));
                bar.style.width = pct + "%";

                if(timeLeft < 4) gameBox.style.boxShadow = "0 0 25px rgba(212, 5, 17, 0.6)";
                if(timeLeft <= 0) {
                    clearInterval(currentTimer);
                    btn.disabled = true;
                    btn.innerHTML = "TIME UP";
                    btn.style.background = "#999";
                }
            }, 1000);
        });

        function submitAnswer() {
            var val = document.getElementById('slider').value;
            if(val == "50") return alert("Please select IDEAL or CHALLENGING.");
            socket.emit('submit_answer', {value: val});

            var btn = document.getElementById('submit_btn');
            btn.disabled = true;
            btn.innerHTML = "WAITING FOR REVEAL...";
            btn.style.background = "#007bff";
        }

        socket.on('feedback', function(data) {
            showScreen('feedback_screen');

            var statusEl = document.getElementById('fb_status');
            var msgEl = document.getElementById('fb_msg');
            var ptsEl = document.getElementById('fb_pts');
            var ansEl = document.getElementById('fb_ans');

            msgEl.innerHTML = data.random_msg;
            ansEl.innerHTML = data.correct_text;
            ptsEl.innerHTML = "+" + data.points;
            document.getElementById('fb_exp').innerHTML = data.explanation;

            if(data.correct) {
                statusEl.innerHTML = "CORRECT";
                statusEl.style.color = "#2ecc71";
                msgEl.style.color = "#2ecc71";
                ptsEl.style.color = "#2ecc71";
                try { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#D40511', '#FFCC00'] }); } catch(e){}
            } else {
                statusEl.innerHTML = "INCORRECT";
                statusEl.style.color = "#D40511";
                msgEl.style.color = "#D40511";
                ptsEl.style.color = "#D40511";
            }

            var bHtml = "";
            if(data.is_fastest) {
                bHtml += "<div class='bonus-tag'>FASTEST (+30)</div>";
                document.getElementById('rr_gif').classList.remove('hidden');
            }
            if(data.streak_bonus) {
                bHtml += "<div class='bonus-tag'>STREAK BONUS (+20)</div>";
            }
            document.getElementById('fb_bonuses').innerHTML = bHtml;
        });

        socket.on('show_leaderboard_all', function(data) {
            var table = document.getElementById('lb_table');
            table.innerHTML = "<tr><th>Rank</th><th>Name</th><th>Score</th></tr>";
            data.leaderboard.forEach((p, i) => {
                table.innerHTML += `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.score}</td></tr>`;
            });

            if(data.is_winner && data.leaderboard.length > 0) {
                document.getElementById('winner_section').classList.remove('hidden');
                document.getElementById('winner_name').innerHTML = data.leaderboard[0].name;
                try { confetti({ particleCount: 500, spread: 100 }); } catch(e){}
            } else {
                document.getElementById('winner_section').classList.add('hidden');
            }

            document.getElementById('lb_overlay').classList.remove('hidden');
        });

        socket.on('hide_leaderboard_all', function() {
            document.getElementById('lb_overlay').classList.add('hidden');
        });

        function showScreen(id) {
            ['login_screen','wait_screen','game_screen','feedback_screen'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }
    </script>
</body>
</html>
